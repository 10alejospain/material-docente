# This is a basic workflow to help you get started with Actions

name: build-pdfs

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - id: files
        uses: jitterbit/get-changed-files@v1
      - name: Setup Node.js environment
        uses: actions/setup-node@v1.4.3
      - name: Build the PDFs of added/changed files
        run: |
          set -x
          assets=()
          for changed_file in ${{ steps.files.outputs.added_modified }}; do
            npx @marpteam/marp-cli $changed_file --allow-local-files -o "$(basename $changed_file .md).pdf"
          done
          for asset in ./*.pdf; do
            assets+=("-a" "$asset")
          done
          tag_name="${GITHUB_REF##*/}"
          hub release create "${assets[@]}" -m "$tag_name" "$tag_name"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
